<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>主页</title>
    <!-- Tell the browser to be responsive to screen width -->
    <meta content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" name="viewport">
    <link rel="stylesheet" href="../css/bootstrap.css">
    <link rel="stylesheet" href="../css/AdminLTE.css">
    <link rel="stylesheet" href="../css/font-awesome.css">
    <link rel="stylesheet" href="../css/_all-skins.css">
    <link rel="stylesheet" href="../css/ui.jqgrid-bootstrap.css">
    <!--  <link rel="shortcut icon" type="image/x-icon" href="http://www.bxpplm.com/favicon.ico"/>-->
  </head>
  <body class="hold-transition skin-blue sidebar-mini">
    <div class="wrapper">
      <header class="main-header">
        <!-- Logo -->
       
        <!-- Header Navbar: style can be found in header.less -->
        <nav class="navbar navbar-static-top" role="navigation">
          <!-- Sidebar toggle button-->
          <a href="#" class="sidebar-toggle" data-toggle="offcanvas" role="button">
            <span class="sr-only">Toggle navigation</span>
          </a>
          <div class="navbar-custom-menu">
            <ul class="nav navbar-nav">
                <li class="dropdown user user-menu">
                <a href="#" class="dropdown-toggle" data-toggle="dropdown">
                  <img src="../img/admin.png" class="user-image" alt="User Image"> 
                  <span class="hidden-xs username"></span>
                </a>
                <ul class="dropdown-menu">
                  <!-- User image -->
                  <li class="user-header">
                    <img src="../img/admin.png" class="img-circle" alt="User Image"> 
                    <p>
                      <!-- 
                      Alexander Pierce - Web Developer
                      <small>Member since Nov. 2012</small>
                       -->
                      <span></span>
                      <small>2012年1月1日 12:33:45</small>
                    </p>
                  </li>
                    
                  <!-- Menu Footer-->
                  <li class="user-footer">
                    <div class="pull-left">
                    	<a href="#" id="changePswd" class="btn btn-default btn-flat" data-toggle="modal" data-target="#chgpswdModal" style="display:none;">修改密码</a>
                    </div>
                    <div class="pull-left">
                    	<a href="javascript:loadU();" id="switchUser" data-index="0" class="btn btn-default btn-flat" data-toggle="toggle" style="display:none;">切换用户</a>
                    	<a href="javascript:backU();" id="backtoUser" data-index="0" class="btn btn-default btn-flat" data-toggle="toggle" style="display:none;" >切回用户</a>
                    </div>
                    <div class="pull-right">
                      <a href="javascript:signout();" id="signout" class="btn btn-default btn-flat">登出</a>
                    </div>
                  </li> 
                </ul>
              </li>
             
            </ul>
          </div>
        </nav>
      </header>
      <!-- Left side column. contains the logo and sidebar -->
      <aside class="main-sidebar">
        <!-- sidebar: style can be found in sidebar.less -->
        <section class="sidebar">
          <!-- Sidebar user panel -->
          <div class="user-panel">
            <div class="pull-left image">
              <img src="../img/admin.png" class="img-circle" alt="User Image">
            </div>
            <div class="pull-left info">
              <p class="username">管理员</p>
              <a href="#"><i class="fa fa-circle text-success"></i> 在线</a>
            </div>
          </div>
          <!-- search form -->
          <form action="#" method="get" class="sidebar-form">
            <div class="input-group">
              <input type="text" name="q" class="form-control" placeholder="搜索...">
              <span class="input-group-btn">
                <button type="submit" name="search" id="search-btn" class="btn btn-flat"><i class="fa fa-search"></i></button>
              </span>
            </div>
          </form>
          <!-- /.search form -->
          <!-- sidebar menu: : style can be found in sidebar.less -->
          <ul class="sidebar-menu" id="qiuer-menu">
          </ul>
        </section>
        <!-- /.sidebar -->
    <div id="sidebar-loader">      
	</div>
</aside>

		<!-- Content Wrapper. Contains page content -->
		<div class="content-wrapper">
			<!-- Content Header (Page header) -->
			<section class="content-header">
				<h1>
					Dashboard <small>Control panel</small>
				</h1>
				<ol class="breadcrumb">
					<li><a href="#"><i class="fa fa-dashboard"></i> 主页</a>
					</li>
					<li class="active">Dashboard</li>
				</ol>
			</section>

			<!-- Main content -->
			<section class="content">
				<iframe id="qiuer-iframe" width="100%" height="800px" frameborder="0" scrolling="auto" src="" onload="javascript:reinitIframeEND();"></iframe>
			</section>
			<!-- /.content -->

		</div>
		<!-- /.content-wrapper -->

		<footer class="main-footer">
			<div class="pull-right hidden-xs">
				<b>Version</b> 1.0.0
			</div>
			<strong>Copyright &copy; 2015-2016 .</strong> All rights reserved.
		</footer>
		
    </div><!-- ./wrapper -->
    
<!-- 模态框（Modal） -->
<div class="modal fade" id="chgpswdModal" tabindex="-1" role="dialog" aria-labelledby="chgpswdModal" aria-hidden="true">
   <div class="modal-dialog" >
      <div class="modal-content">
         <div class="modal-header">
            <button type="button" class="close" 
               data-dismiss="modal" aria-hidden="true">
                  &times;
            </button>
            <h4 class="modal-title">
               	<b>修改密码</b>
            </h4>
         </div>
         <div >
         <div class="modal-body">
         	<label class="col-sm-4" align="right">原始密码：</label>
         	<div class="col-sm-8">
                <input  type="password" id="olduserpswd" name="olduserpswd" minlength="2"  required="" aria-required="true">
            </div>
         </div>
         <p/>
          <div class="modal-body">
         	<label class="col-sm-4 " align="right">修改密码：</label>
         	<div class="col-sm-8">
                <input  type="password" id="newuserpswd" name="newuserpswd" minlength="2"   required="" aria-required="true">
            </div>
         </div>
         <p/>
          <div class="modal-body">
         	<label class="col-sm-4 " align="right">确认密码：</label>
         	<div class="col-sm-8">
                <input  type="password" id="newuserpswd2" name="newuserpswd2" minlength="2"  required="" aria-required="true">
            </div>
         </div>
         </div>
         <br/>
         <div class="modal-footer">
            <button type="reset" class="btn btn-default" 
               data-dismiss="modal">取消
            </button>
            <button type="button" id="frmcommit"" onclick="changepswd();" class="btn btn-primary" >
               	提交更改
            </button>
         </div>
      </div><!-- /.modal-content -->
	</div><!-- /.modal -->
</div>

<!-- 模态框（Modal） -->
<div class="modal fade" id="changeUser" tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel" >
<div class="modal-dialog" role="document">
<div class="modal-content">
<!-- header -->
<div class="modal-header">
     <button type="button" class="close" data-dismiss="modal" aria-label="Close">
             <i class="fa fa-close"></i>
     </button>
     <h4 class="modal-title" id="infoModalLabel"><b>用户列表</b></h4>
</div>
<div class="modal-body">
	<table id="jqg-main"></table>
	<div id="jqg-main-pager"></div>
</div>
<div class="modal-footer">
<button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
<button type="submit" class="btn btn-primary" onclick="switchU();">确定</button>
</div>
</div>
</div>
</div>
	<script src="../js/jquery.js"></script>
	<script src="../js/bootstrap.js"></script>
	<script src="../js/jquery.jqGrid.js"></script>
	<script src="../js/grid.locale-cn.js"></script>
    <script src="../js/app.js"></script>
    <script src="../js/qiuer-main.js"></script>
    <script src="../js/center-loader.js"></script> <!-- load旋转 改造 -->
    <script src="../js/jquery.md5.js"></script>
    <script src="../js/qiuer.util.js"></script>
<script type="text/javascript" language="javascript">

	$.jgrid.defaults.styleUI = 'Bootstrap';	
	$(document).ready(function () {
			   $("#sidebar-loader").loader("show","<i class=\"fa fa-4x fa-spinner fa-spin\"></i>");
				refresh();
				function n() {
					var t = $(this).attr("href"),
					a = $(this).data("index"),
					i = $.trim($(this).text()),
					n = !0;
					//菜单导航
					$(".content-wrapper .content-header h1").html($(this).text());
					$(".content-wrapper .content-header .breadcrumb .active").html($(this).text());
					$("#qiuer-iframe").attr("src",t);
					return ! 1
				}
				$(document).on("click",".qiuer-menuitem", n);
				setDynamicClock();
				//$(".qiuer-menuitem").on("click", n);
				$(window).resize(reinitIframeEND);
		});
		function getUserName(){
		
			var username = ReadCookie("username");
			$(".username").html(username);
			$(".user-header p span").html(username);

		}
		function getContextPath(){ 
			var pathName = document.location.pathname; 
			var index = pathName.substr(1).indexOf("/"); 
			var result = pathName.substr(0,index+1); 
			return result; 
		} 
		function ReadCookie(cookieName) {
		    var theCookie = "" + document.cookie;
		    var ind = theCookie.indexOf(cookieName);
		    if(ind==-1 || cookieName=="") return "";
		    var ind1 = theCookie.indexOf(';',ind);
		    if(ind1==-1) ind1 = theCookie.length;
		    return unescape(theCookie.substring(ind+cookieName.length+1,ind1));
		}
		function SetCookie(cookieName,cookieValue,nDays) {
		    var today = new Date();
		    var expire = new Date();
		    if(nDays == null || nDays == 0) nDays = 1;
		    expire.setTime(today.getTime() + 3600000 * 24 * nDays);
		    document.cookie = cookieName + "=" + escape(cookieValue)
		        + ";expires=" + expire.toGMTString()+";path="+getContextPath();
		}
		function setDynamicClock(){
			   var dt = new Date();
			   var year=dt.getFullYear();
			   var month=dt.getMonth()+1;
			   var day=dt.getDate();
               var h=$.pad0(dt.getHours(),2);
       		   var m=$.pad0(dt.getMinutes(),2);
      		   var s=$.pad0(dt.getSeconds(),2);
      		   $(".user-header p small").text(year+"年"+month+"月"+day+"日"+" "+h+":"+m+":"+s);
      		   window.setTimeout("setDynamicClock()", 1000);  
		}
		
		function setinit(){
			$("#qiuer-iframe").attr("src",$(".qiuer-menuitem").first().attr("href"));
			$(".content-wrapper .content-header h1").html($(".qiuer-menuitem").first().find("span").html());
			$(".content-wrapper .content-header .breadcrumb .active").html($(".qiuer-menuitem").first().find("span").html());
		}
		function loadU(){
			$.jgrid.styleUI.Bootstrap.base.rowTable = "table table-bordered table-striped";
			$("#jqg-main").jqGrid({
				url: getContextPath()+"/user/list",
				mtype: "POST",
				height:220,
				width: "100%",
				ajaxGridOptions: { contentType: "application/json; charset=utf-8" },
				datatype : "json",
				//datatype : "local",
				//data : mydata,
				shrinkToFit: true,
				colModel: [
					{ label: "用户代码", name: "userid", align: "left"},
					{ label: "用户名称", name: "username",align: "left"}
				],
				rownumbers: true,
				loadonce: true,
				viewrecords: false
			});
			//$("#jqg-main").jqGrid('filterToolbar');
			$("#gbox_jqg-main,#gbox_jqg-main .ui-jqgrid-hdiv,#gbox_jqg-main .ui-jqgrid-bdiv table,#gview_jqg-main,#gbox_jqg-main .ui-jqgrid-hdiv .ui-jqgrid-hbox table").attr("style","width:100%;");
			$("#jqg-main,table[aria-labelledby=gbox_jqg-main]").attr("style","width:550px;");
			$("#gbox_jqg-main .ui-jqgrid-bdiv").attr("style","width:100%;height:220px;");
			$("#changeUser").modal("show");
		}
		function changeU(param){
			$.ajax({
					data : param,
					//type : "POST",
					contentType : "application/json; charset=utf-8",
					dataType : "json",
					url : getContextPath()+"/user/changeu",
					error : function(XMLHttpRequest, textStatus, errorThrown) {
						alert(XMLHttpRequest.status);
						alert(XMLHttpRequest.readyState);
						alert(textStatus);
						alert("error:" + data.msg);
					},
					success : function(data) {
						if(data.code==0){
							SetCookie("userid",data.userid,7);
							SetCookie("username",data.username,7);
							$("#changeUser").modal("hide");
							alert(data.msg);
							refresh();	
							//location.href=getContextPath()+"/html/main.html";
							
						}
					}
				});
				
		}
		function switchU(){
			var gr = $("#jqg-main").jqGrid('getGridParam', 'selrow');
			var rowData = $("#jqg-main").jqGrid("getRowData",gr);
			var userid = rowData.userid;
			var loginuser = ReadCookie("loginuser");
			//SetCookie("loginuser",loginuser,7);
			if(userid == loginuser){
				alert("同一用户无需切换");
			}else{
			var param = {"userid":userid};
			changeU(param);	
			document.getElementById("switchUser").style.display="none";
			document.getElementById("backtoUser").style.display="block";
			}	
		}
		function backU(){
			var loginuser = ReadCookie("loginuser");
			var params={"userid":loginuser};
			changeU(params);
			document.getElementById("switchUser").style.display="block";
			document.getElementById("backtoUser").style.display="none";	
		}
		function reinitIframeEND() {
			var iframe = document.getElementById("qiuer-iframe");
			try {
				var bHeight = iframe.contentWindow.document.body.scrollHeight;
				var dHeight = iframe.contentWindow.document.documentElement.scrollHeight;
				//alert("bHeight="+bHeight + " dHeight=" + dHeight);
				var height = Math.max(bHeight, dHeight)+20;
				iframe.height = height;
			} catch (ex) {
				alert(ex);
			}
		}
		function signout(){
						var userid = ReadCookie("userid");
						$.ajax({
							data : null,
							//type : "POST",
							contentType : "application/json; charset=utf-8",
							dataType : "json",
							async : true,//同步
							url : getContextPath()+"/user/signout",
							error : function(XMLHttpRequest, textStatus, errorThrown) {
								alert(XMLHttpRequest.status);
								alert(XMLHttpRequest.readyState);
								alert(textStatus);
							},
							success : function(data) {
								if(data.code==0){
									
									alert(data.msg);
									location.href=getContextPath()+"/login.html";
								}	
							}
						});
		}
		function changepswd() {
			var userid =  ReadCookie("userid");
		   	var olduserpswd = $("#olduserpswd").val();
		   	var newuserpswd = $("#newuserpswd").val();
		   	var newuserpswd2 = $("#newuserpswd2").val();
		   	if (olduserpswd.length<1) {
		   		alert("原始密码不能为空"); return;
		   	}
		   	if (newuserpswd.length < 1 || newuserpswd2.length < 1) {
		   		alert("新密码不能为空"); return;
		   	}
		   	if(newuserpswd!=newuserpswd2){
		   		alert("新密码两次输入不相同！");
		   		return;
		   	}
		   	
		   	$.ajax({
				data : {
		      				"userid":userid,
		      				"olduserpswd": $.md5(olduserpswd).toUpperCase(),
		      				"newuserpswd": $.md5(newuserpswd).toUpperCase()
				},
				//type : "POST",
				contentType : "application/json; charset=utf-8",
				dataType : "json",
				async : true,//同步
				url : getContextPath()+"/user/chgpswd",
				error : function(XMLHttpRequest, textStatus, errorThrown) {
					alert(XMLHttpRequest.status);
					alert(XMLHttpRequest.readyState);
					alert(textStatus);
				},
				success : function(data) {
					if(data.code==0){
						$("#olduserpswd").val("");
						$("#newuserpswd").val("");
						$("#newuserpswd2").val("");
						$("#chgpswdModal").modal("hide");
						alert(data.msg);
						//location.href=data.data.url;
					}	
				}
			});
	   }
	   function getActions(){
	   		var userid =  ReadCookie("userid");
	   		var menuid = 0;
	   			$.ajax({
				data : {
		      				"userid":userid,
		      				"menuid":menuid
				},
				contentType : "application/json; charset=utf-8",
				dataType : "json",
				async : true,//同步
				url : getContextPath()+"/permission/actions",
				error : function(XMLHttpRequest, textStatus, errorThrown) {
					alert(XMLHttpRequest.status);
					alert(XMLHttpRequest.readyState);
					alert(textStatus);
				},
				success : function(data) {
					   if(data.length>0){
						for(var i=0;i<data.length;i++){   
					 　　　　for(var key in data[i]){  
					 		if(key == "actionname"){
					          blockAction(data[i][key]); 
					         }
					        }   
  						}
  					   }
				}
			});
	   }	   
	   function blockAction(actionname)
	   {
	   		document.getElementById(actionname).style.display="block";
	   }
	   function getMenus()
	   {
	   		var userid =  ReadCookie("userid");
	   		$.ajax({
				data : {
		      				"userid":userid
				},
				contentType : "application/json; charset=utf-8",
				dataType : "json",
				async : true,//同步
				url : getContextPath()+"/permission/menus",
				error : function(XMLHttpRequest, textStatus, errorThrown) {
					alert(XMLHttpRequest.status);
					alert(XMLHttpRequest.readyState);
					alert(textStatus);
				},
				success : function(data) {
					   //if(data.length>0){
						//for(var i=0;i<data.length;i++){   
					 　　　　 	//alert(JSON.stringify(data));
  						//}
  					   //} 
  					   loadmenu("qiuer-menu",data);
					   $("#sidebar-loader").loader("hide","<i class=\"fa fa-4x fa-spinner fa-spin\"></i>");
  					   setinit();
				}
			});
		
	   }
	  
	   function refresh(){
			getUserName();
			getActions();
			getMenus();
		}
	</script>
</body>
</html>
